
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Preprocessing with fMRIprep &#8212; The Princeton Handbook for Reporducible Neuroimaging</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <link rel="canonical" href="https://brainhack-princeton.github.io/handbook//content_pages/03-03-fmriprep.html" />
    <link rel="shortcut icon" href="../_static/tigerBrain_favicon.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Understanding your fMRIprep outputs" href="03-04-fmriprepOutputs.html" />
    <link rel="prev" title="Quality control with MRIQC" href="03-02-mriqc.html" />
  

  

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    div.body {
      min-width: initial;
      max-width: initial;
    }
  </style>

  
  <link rel="canonical" href="https://handbook.datalad.org/content_pages/03-03-fmriprep/"/>
  <meta property="og:url" content="https://handbook.datalad.org/content_pages/03-03-fmriprep">
  

  <link rel="icon" type="image/png" href="https://media.readthedocs.org/images/favicon.png">

  <meta name="twitter:card" content="summary">
  <meta property="twitter:image" content="https://handbook.datalad.org/_static/social-card.jpg">
  <meta property="og:image" content="https://handbook.datalad.org/_static/social-card.jpg">
  <meta property="og:title" content="Preprocessing with fMRIprep &#8212; The Princeton Handbook for Reporducible Neuroimaging">
  <meta property="og:type" content="article">
  
  <meta property="og:description" content="">


  </head><body>
  <script type="text/javascript">

  $(window).scroll(function () {
    var s = $(window).scrollTop(),
          d = $(document).height(),
          c = $(window).height();
          scrollPercent = (s / (d-c)) * 100;
          var position = scrollPercent;

     $("#progressbar").attr('value', position);
  });
  </script>

  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><p class="logo">
  <a href="../index.html">
    <img class="logo" width="500" src="../_static/tigerBrain.png" title="The Princeton Handbook on Reproducible Neuroimaging"/>
  </a>
</p>

<!-- <p style="margin-left:auto; margin-right: auto;"><iframe src="https://ghbtns.com/github-btn.html?repo=book&user=datalad-handbook&type=star&count=true&size=large" allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe></p> -->

<!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" /> -->
<style>
.algolia-autocomplete{
  width: 100%;
  height: 1.5em
}
.algolia-autocomplete a{
  border-bottom: none !important;
}
#doc_search{
  width: 100%;
  height: 100%;
}
</style>

<progress id="progressbar" value="0" max="100"></progress>
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Preprocessing with fMRIprep</a><ul>
<li><a class="reference internal" href="#preprocessing-fmriprep">Preprocessing (fMRIPrep)</a></li>
<li><a class="reference internal" href="#quality-checks-mriqc">Quality checks (MRIQC)</a></li>
<li><a class="reference internal" href="#checking-the-output-of-fmriprep-and-mriqc">Checking the output of fMRIprep and MRIQC</a></li>
<li><a class="reference internal" href="#mriqc">MRIQC</a></li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
      <li>Previous: <a href="03-02-mriqc.html" title="previous chapter">Quality control with MRIQC</a></li>
      <li>Next: <a href="03-04-fmriprepOutputs.html" title="next chapter">Understanding your fMRIprep outputs</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><!-- Alabaster (krTheme++) Hacks -->
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            <div style="display:block;position:relative; margin-bottom: 1em;">
              <div style="display:block;width:100%;padding-top:12.5%;"></div>
              <div class="rpad" data-unit="8x1" style="position:absolute;left:0;top:0;right:0;bottom:0;overflow:hidden;"></div>
            </div>
            
  <div class="section" id="preprocessing-with-fmriprep">
<span id="fmriprep"></span><h1>Preprocessing with fMRIprep<a class="headerlink" href="#preprocessing-with-fmriprep" title="Permalink to this headline">¶</a></h1>
<style> .blue {color:blue} </style>
<style> .red {color:red} </style><p>Once you’ve converted your fMRI data to BIDS, you can begin preprocessing the data using fMRIPrep (<a class="reference external" href="https://doi.org/10.1101/306951">Esteban et al 2019</a>). FMRIprep is a BIDS App—a tool specifically designed to capitalize on the standardized format and rich metadata of BIDS. Each version of fMRIPrep is released as a <a class="reference external" href="https://www.docker.com/">Docker</a> container (an encapsulated software environment containing all dependencies). For use on a fMRIPrep is packaged as a Docker container. For most purposes, we recommend running fMRIPrep on your institutions server (instead of locally). To run fMRIPrep on server without administrative privileges, we use <a class="reference external" href="https://www.sylabs.io/docs/">Singularity</a> (<a class="reference external" href="https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0177459">Kurtzer et al 2017</a>) instead of Docker. Singularity must be installed on the server to build and run Singularity images such as fMRIPrep. The fMRIPrep Docker image can be converted to a Singularity image for use on the server by running Singularity’s build command on Poldrack Lab’s fMRIPrep Docker image on Docker Hub:</p>
<ul class="simple">
<li><dl class="simple">
<dt>Building the Singularity image:</dt><dd><ul>
<li><p>singularity build fmriprep.sqsh docker://poldracklab/fmriprep</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
<p>Running fMRIPrep on a single subject may take several hours. To run the fMRIPrep on the server, we recommend using your institution’s job scheduler—in our case <a class="reference external" href="https://slurm.schedmd.com/">Slurm</a>. Alternatively, you can create a persistent interactive session using, e.g., <a class="reference external" href="https://github.com/tmux/tmux">tmux</a> or screen to ensure that the fMRIPrep keeps running even if you lose your network connection.</p>
<div class="section" id="preprocessing-fmriprep">
<h2>Preprocessing (fMRIPrep)<a class="headerlink" href="#preprocessing-fmriprep" title="Permalink to this headline">¶</a></h2>
<p>Now that you have used heudiconv to get your data as nifti’s into the BIDS format and indicated which functional runs have to be corrected with which fieldmaps, you should run fMRIPrep to preprocess these data. You can do this by running the script (<span class="blue">slurm_fmriprep.sh</span>) that needs to script run_fmriprep.sh (both in <span class="blue">new_study_template/code/preprocessing/</span>).</p>
<p>This script will run fmriprep for an individual subject using slurm.</p>
<p><em>Before running for the first time:</em></p>
<ul class="simple">
<li><p>Make sure your paths are correct in globals.sh. If you need to, run one line at a time in slurm_fmriprep.sh to make sure the paths are correct.</p></li>
<li><p>Find more on how to customize your fMIRprep command line argument here.</p></li>
<li><p>If planning to run using a job scheduler (slurm in particular), open slurm_fmriprep.sh and update the array number to be your subject number (you can run multiple subjects at the same time by using arrays).</p></li>
<li><p>Update to include your email address if you want to get email alerts when the code is running/completed.</p></li>
</ul>
<p><em>Submit job from code directory:</em></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Example code:</span>
<span class="nb">cd</span> /jukebox/norman/pygers/handbook/sample_project/code/preprocessing/
sbatch slurm_fmriprep.sh
</pre></div>
</div>
</div>
<div class="section" id="quality-checks-mriqc">
<h2>Quality checks (MRIQC)<a class="headerlink" href="#quality-checks-mriqc" title="Permalink to this headline">¶</a></h2>
<p>To get an idea of the quality of your fMRI data, you can use the MRI Quality Check (MRIQC) which is the script slurm_mriqc.sh (which you can find in <span class="blue">/jukebox/norman/pygers/handbook/code/</span>). This script will need <span class="blue">run_mriqc.sh</span> and <span class="blue">run_mriqc_group.sh</span>. This script will run mriqc (quality metrics) for an individual subject followed by the group summary statistics using slurm.</p>
<p><em>Before running for the first time:</em></p>
<ul class="simple">
<li><p>Open <span class="blue">slurm_mriqc.sh</span> and update the array number to be your subject number (you can run multiple subjects at the same time by using arrays).</p></li>
<li><p>Update to include your email address if you want to get email alerts when the code is running/completed.</p></li>
</ul>
<p><em>Submit job from code directory:</em></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> /jukebox/norman/pygers/handbook/sample_project/code/preprocessing/
</pre></div>
</div>
</div>
<div class="section" id="checking-the-output-of-fmriprep-and-mriqc">
<h2>Checking the output of fMRIprep and MRIQC<a class="headerlink" href="#checking-the-output-of-fmriprep-and-mriqc" title="Permalink to this headline">¶</a></h2>
<p>FMRIprep will output your data in the <span class="blue">/derivatives</span> directory of your folder. After fmriprep successfully runs, this is what your bids <span class="blue">directory/derivatives/</span> will look like (adapted from BIDSification):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ tree

└── new_study_template
    └── data
        └── bids
            └── sub-001
            └── sub-002
            └── etc.
            └── derivatives          <span class="c1"># this is where all your BIDS derivatives will be</span>

                └── mriqc            <span class="c1"># mriqc output will go here</span>
                    └── logs         <span class="c1"># slurm logs will go here</span>
                └── fmriprep         <span class="c1"># fmriprep-preprocessed data will go here</span>
                    └── logs         <span class="c1"># slurm logs will go here</span>
                        └── sub-001          <span class="c1"># all data from sub-001 will go here</span>
                            └── anat         <span class="c1"># all anatomical preprocessing</span>
                            └── func         <span class="c1"># all functional preprocessing in all output spaces</span>
                        └── sub-001.html     <span class="c1"># summary of all of sub-001 preprocessing</span>
                └── freesurfer               <span class="c1"># if you ran freesurfer, the output data will go here (covered more in detail in the registration section)</span>
                └── work                             <span class="c1"># all intermediate outputs from fmriprep</span>
</pre></div>
</div>
<p><strong>fMRIprep html:</strong></p>
<p>To have a quick look at the output of fMIRprep and make sure the analysis went through without issues check the html outputs (saved in “fmriprep” folder along with subject folders)
File begins with a brief summary, including info such as what structural images and resampling targets were used in the analysis and which functional runs were analyzed.</p>
<p>Some general points about the html file (for more details check <a class="reference external" href="https://fmriprep.readthedocs.io/en/stable/outputs.html#confounds">here</a>):</p>
<ul class="simple">
<li><p>The images are dynamic and portray before/afters.</p></li>
<li><p>Summary of the flags used in the actual fMRIprep analysis and all the collected confounds are summarized for each run.</p></li>
<li><p>You can get a quick sense of the quality of the signal by looking at the <a class="reference external" href="https://www.sciencedirect.com/science/article/pii/S1053811916303871?via%3Dihub">carpetplots</a> and see the effect of motion (FD) and fluctuations of the global signal in whole-brain (brain mask), CSF and white matter over the time-course.</p></li>
<li><p>The section on the correlations among nuisance regressors can guide the decisions on removing confounds.</p></li>
</ul>
</div>
<div class="section" id="mriqc">
<h2>MRIQC<a class="headerlink" href="#mriqc" title="Permalink to this headline">¶</a></h2>
<p>MRIQC outputs an MRIQC group bold report and separate MRIQC reports for each subject/session. To have a quick look at the quality of the data acquired for your subjects, a good first start is to look at the group bold report to see if the <a class="reference external" href="https://mriqc.readthedocs.io/en/stable/measures.html">image quality metrics</a> shows any outlier subjects/sessions with respect to the quality of the data. When this is the case, you should check the subject/session-specific MRIQC to see if you can figure out what went wrong. It is recommended that you always check the framewise displacement and temporal SNR.</p>
<a class="reference external image-reference" href="01-06-overview.html"><img alt="return to timeline" class="align-center" src="../_images/return_to_timeline.png" style="width: 300px;" /></a>
</div>
</div>


          </div>
              <div class="related bottom">
                &nbsp;
  <nav id="rellinks">
    <ul>
        <li>
          &larr;
          <a href="03-02-mriqc.html" title="Previous document">Quality control with MRIQC</a>
        </li>
        <li>
          <a href="03-04-fmriprepOutputs.html" title="Next document">Understanding your fMRIprep outputs</a>
          &rarr;
        </li>
    </ul>
  </nav>
              </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
<div class="footer">
  <div style="text-align: left;" id="waldo-tag-2171"></div>
  <p>&copy;2020 CC-BY-SA - <a href="website_info.html">Website Info</a></p>
</div>


 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>

  </body>
</html>