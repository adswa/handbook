
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Converting data to BIDS &#8212; The Princeton Handbook for Reporducible Neuroimaging</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <link rel="canonical" href="https://brainhack-princeton.github.io/handbook//content_pages/03-02-converting.html" />
    <link rel="shortcut icon" href="../_static/tigerBrain_favicon.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Quality control with MRIQC" href="03-03-mriqc.html" />
    <link rel="prev" title="One standard to rule them all" href="03-01-standard.html" />
  

  

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    div.body {
      min-width: initial;
      max-width: initial;
    }
  </style>

  
  <link rel="canonical" href="https://handbook.datalad.org/content_pages/03-02-converting/"/>
  <meta property="og:url" content="https://handbook.datalad.org/content_pages/03-02-converting">
  

  <link rel="icon" type="image/png" href="https://media.readthedocs.org/images/favicon.png">

  <meta name="twitter:card" content="summary">
  <meta property="twitter:image" content="https://handbook.datalad.org/_static/social-card.jpg">
  <meta property="og:image" content="https://handbook.datalad.org/_static/social-card.jpg">
  <meta property="og:title" content="Converting data to BIDS &#8212; The Princeton Handbook for Reporducible Neuroimaging">
  <meta property="og:type" content="article">
  
  <meta property="og:description" content="">


  </head><body>
  <script type="text/javascript">

  $(window).scroll(function () {
    var s = $(window).scrollTop(),
          d = $(document).height(),
          c = $(window).height();
          scrollPercent = (s / (d-c)) * 100;
          var position = scrollPercent;

     $("#progressbar").attr('value', position);
  });
  </script>

  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><p class="logo">
  <a href="../index.html">
    <img class="logo" width="500" src="../_static/tigerBrain.png" title="The Princeton Handbook on Reproducible Neuroimaging"/>
  </a>
</p>

<!-- <p style="margin-left:auto; margin-right: auto;"><iframe src="https://ghbtns.com/github-btn.html?repo=book&user=datalad-handbook&type=star&count=true&size=large" allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe></p> -->

<!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" /> -->
<style>
.algolia-autocomplete{
  width: 100%;
  height: 1.5em
}
.algolia-autocomplete a{
  border-bottom: none !important;
}
#doc_search{
  width: 100%;
  height: 100%;
}
</style>

<progress id="progressbar" value="0" max="100"></progress>
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Converting data to BIDS</a><ul>
<li><a class="reference internal" href="#benefits-of-using-bids-format">Benefits of using BIDS format</a></li>
<li><a class="reference internal" href="#convert-dicoms-to-bids-formatted-nifti">Convert dicoms to BIDS-formatted Nifti</a><ul>
<li><a class="reference internal" href="#step-1-setting-up-your-directory-structure"><em>Step 1: Setting up your directory structure</em></a></li>
<li><a class="reference internal" href="#step-2-convert-your-dicoms-into-nifti-files-through-heudiconv"><em>Step 2: Convert your dicoms into nifti files through heudiconv</em></a></li>
<li><a class="reference internal" href="#step-3-get-your-data-ready-to-pass-bids-validation"><em>Step 3: Get your data ready to pass bids-validation</em></a></li>
<li><a class="reference internal" href="#step-4-run-the-bids-validator"><em>Step 4: Run the BIDS validator</em></a></li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
      <li>Previous: <a href="03-01-standard.html" title="previous chapter">One standard to rule them all</a></li>
      <li>Next: <a href="03-03-mriqc.html" title="next chapter">Quality control with MRIQC</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><!-- Alabaster (krTheme++) Hacks -->
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            <div style="display:block;position:relative; margin-bottom: 1em;">
              <div style="display:block;width:100%;padding-top:12.5%;"></div>
              <div class="rpad" data-unit="8x1" style="position:absolute;left:0;top:0;right:0;bottom:0;overflow:hidden;"></div>
            </div>
            
  <div class="section" id="converting-data-to-bids">
<span id="converting"></span><h1>Converting data to BIDS<a class="headerlink" href="#converting-data-to-bids" title="Permalink to this headline">¶</a></h1>
<style> .blue {color:blue} </style>
<style> .red {color:red} </style><div class="section" id="benefits-of-using-bids-format">
<h2>Benefits of using BIDS format<a class="headerlink" href="#benefits-of-using-bids-format" title="Permalink to this headline">¶</a></h2>
<p>BIDS is a standard and widely-used format of structuring data. It facilities:</p>
<ul class="simple">
<li><p><strong>Using and re-using data:</strong> by arranging data in a standard way, using datasets collaboratively within and across labs will be facilitated (no need to rearrange data). It also facilitates future usages of the same datasets (easier to figure out old codes).</p></li>
<li><p><strong>Data analysis:</strong> There are several software packages that accept only BIDS format as input – such as fMRIprep and MRIQC. And the number of these BIDS apps are growing.</p></li>
<li><p><strong>Sharing data:</strong> Data sharing is an important element of reproducible science and a standard data sharing formatting is required for this purpose. Currently OpenNeuro accepts datasets in BIDS format. Some grants require public data sharing and using BIDS from the beginning of data collection can save time and energy at the time of sharing.</p></li>
<li><p><strong>Checking data integrity:</strong> By validating your data structure through bids-validator, potential problems or errors in the data can be discovered.</p></li>
</ul>
<p><a class="reference external" href="https://bids-specification.readthedocs.io/en/stable/">Find out more about BIDS data specifications here</a>.</p>
</div>
<div class="section" id="convert-dicoms-to-bids-formatted-nifti">
<h2>Convert dicoms to BIDS-formatted Nifti<a class="headerlink" href="#convert-dicoms-to-bids-formatted-nifti" title="Permalink to this headline">¶</a></h2>
<p>The first step once you have the DICOM-images of your experiment in the BIDS-format is to convert your dicoms into nifti-images and, in the case you have acquired fieldmaps, to make sure the fieldmap corrections are applied to the correct functional runs.</p>
<div class="section" id="step-1-setting-up-your-directory-structure">
<h3><em>Step 1: Setting up your directory structure</em><a class="headerlink" href="#step-1-setting-up-your-directory-structure" title="Permalink to this headline">¶</a></h3>
<p>Getting data off the scanner in a BIDS-formatted way requires that your directories are made in a specific way. To make things simpler, we have made the folders already for you. Copy the folder <span class="blue">new_study_template</span> into whichever path you would like. The location is <span class="blue">/jukebox/norman/pygers/handbook/new_study_template</span>.</p>
<p>The specific steps to copy the folder using the terminal are as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># log into spock or scotty</span>
ssh username@spock.pni.princeton.edu
ssh username@scotty.pni.princeton.edu
<span class="c1"># copy the study template to your own path</span>
cp -r /jukebox/norman/pygers/handbook/new_study_template /jukebox/YOURLAB/username/
</pre></div>
</div>
<p>Here is the heirarchy of the folders in the <span class="blue">new_study_template</span> folder. <strong>Read the footnotes because if you don’t, none of the following steps will work!</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ tree

└── new_study_template               <span class="c1"># copy this directory to setup the entire directory structure for a new project</span>
    └── code
        └── preprocessing            <span class="c1"># SEE FOOTNOTE 1. this is where heudiconv, fmriprep, etc. scripts live</span>
            └── license.txt          <span class="c1"># SEE FOOTNOTE 2. download a freesurfer license file and save here</span>
        └── analysis                 <span class="c1"># [example] any other code can live at this level</span>
        └── task                     <span class="c1"># [example]</span>
    └── data
        └── bids                     <span class="c1"># this is where raw BIDS data will be saved by HeudiConv</span>
            └── sub-001
            └── sub-002
            └── etc.
            └── derivatives          <span class="c1"># this is where all your BIDS derivatives will be</span>
                └── mriqc            <span class="c1"># mriqc output will go here</span>
                    └── logs         <span class="c1"># slurm logs will go here</span>
                └── fmriprep         <span class="c1"># fmriprep-preprocessed data will go here</span>
                    └── logs         <span class="c1"># slurm logs will go here</span>
                └── freesurfer
            └── .bidsignore          <span class="c1"># similar to .gitignore, list all files/directories you don’t want to be checked by the bids validator</span>
        └── dicom                    <span class="c1"># raw dicoms copied from the scanner go here</span>
            └── check_volumes        <span class="c1"># outputs checking that all dicoms transferred</span>
        └── T1w_defaced              <span class="c1"># SEE FOOTNOTE 3. defaced T1 images</span>
        └── behavioral               <span class="c1"># [example] any other data can live at this level</span>
</pre></div>
</div>
</div>
<div class="section" id="step-2-convert-your-dicoms-into-nifti-files-through-heudiconv">
<h3><em>Step 2: Convert your dicoms into nifti files through heudiconv</em><a class="headerlink" href="#step-2-convert-your-dicoms-into-nifti-files-through-heudiconv" title="Permalink to this headline">¶</a></h3>
<p>The script step1_preproc.sh (in new_study_template/code/preprocessing) needs your dicom images as input, unzips them, and converts them to nifti-images (fitting within the BIDS format) using heudiconv. You run this script for each subject and each session separately. <a class="reference external" href="https://heudiconv.readthedocs.io/en/latest/">Heudiconv is a flexible DICOM converter for organizing brain imaging data into structured directory layouts</a>.</p>
<p>It needs three inputs:
1. subjectID
2. sessionID
3. the name of the directory that contains your DICOM-images of that subject/session (at Princeton, this is in the “conquest” directory).</p>
<p>The step1_preproc.sh script will also need the number_of_files.py script and run_heudiconv.py script (also in <span class="blue">new_study_template/code/preprocessing</span>).</p>
<p>Before running the first time, you should make sure that you have properly updated your paths. If you need to, run <span class="blue">step1_preproc.sh</span> line by line to check that the correct paths will go into <span class="blue">run_heudiconv.py</span>. If you have not already done this, follow footnote 2 above and update <span class="blue">globals.sh</span> with your directory info!</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># make sure you&#39;re in the preprocessing directory</span>
<span class="nb">cd</span> /Volumes/YOURLAB/USERNAME/new_study_template/code/preprocessing
<span class="c1"># run the script step1_preproc.sh for session 01 and subject 999</span>
./step1_preproc.sh <span class="m">999</span> <span class="m">01</span> <span class="o">[</span>conquest folder name<span class="o">]</span>

<span class="c1"># NOTE: For our sample project, use the following command</span>
./step1_preproc.sh <span class="m">001</span> <span class="m">01</span> 0219191_mystudy-0219-1114
</pre></div>
</div>
<p>Other things to know:</p>
<ul class="simple">
<li><p>Whatever subjectID you use as your first input, that will be how your BIDS subject folders are named (eg., inputting 999 above will result in a directory called sub-999). SessionID (second input) should match how your runs were named on the scanner (e.g., input 01 for sessionID if your runs were named <span class="blue">func_ses-01_task-study_run-01</span>).</p></li>
<li><dl class="simple">
<dt>Recommended to run this in a tmux window so you don’t run into issues with losing connection to server, etc. After ssh-ing into the server, run the following to create or attach to a tmux window (NOTE: replace [name] with whatever you want to call the new tmux session you are opening, then you can attach to that specific window/session in the future):</dt><dd><ul>
<li><p>Create a new tmux window: <code class="docutils literal notranslate"><span class="pre">tmux</span> <span class="pre">new</span> <span class="pre">-s</span> <span class="pre">[name]</span></code></p></li>
<li><p>Attach to an existing window: <code class="docutils literal notranslate"><span class="pre">tmux</span> <span class="pre">a</span> <span class="pre">-t</span> <span class="pre">[name]</span></code></p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>To check name of subject folders on conquest:</dt><dd><ul>
<li><p>Skyra - <code class="docutils literal notranslate"><span class="pre">ls</span> <span class="pre">/jukebox/dicom/conquest/Skyra-AWP45031/NormaL/2019</span></code></p></li>
<li><p>Prisma - <code class="docutils literal notranslate"><span class="pre">ls</span> <span class="pre">/jukebox/dicom/conquest/Prisma-MSTZ400D/NormaL/2019</span></code></p></li>
</ul>
</dd>
</dl>
</li>
<li><p>If heudiconv is failing, check that your original dicoms are only zipped one time (meaning .gz is the only extension instead of .gz.gz). If your dicoms are zipped multiple times, add another line for gunzipping again! Basically do this until you have dcm’s!</p></li>
</ul>
</div>
<div class="section" id="step-3-get-your-data-ready-to-pass-bids-validation">
<h3><em>Step 3: Get your data ready to pass bids-validation</em><a class="headerlink" href="#step-3-get-your-data-ready-to-pass-bids-validation" title="Permalink to this headline">¶</a></h3>
<p>The script <span class="blue">step2_preproc.sh</span> (<span class="blue">new_study_template/code/preprocessing</span>) will delete extra files (e.g., scouts), rename fieldmaps, and add the “IntendedFor” field to the fieldmap .json files. It needs the subjectID as input.</p>
<p>NOTE:</p>
<ul class="simple">
<li><p>This script will need to be customized for your study, by adapting the fieldmap .json to indicate which functional runs you want the fieldmaps to be applied to.</p></li>
<li><p>Only run this after all MRI sessions of the subject have been run through step1_preproc.</p></li>
<li><p>If you run bids-validation and get any warnings and/or errors, put any modifications you needed to make to pass the validator into this script so you can easily get subjects ready for bids apps as you collect more subjects. <strong>Again, this script should be customized for your experiment and not just run without editing.</strong></p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># run the script (step2_preproc.sh), e.g. for subject 999</span>
./step2_preproc.sh <span class="m">999</span>

<span class="c1"># NOTE: For our sample project, use the following command</span>
./step2_preproc.sh <span class="m">001</span>
</pre></div>
</div>
<p>Other things to note:
* If an individual subject’s scanning protocol deviated at all from the standard (e.g., there was an extra run of a task), then make sure that run is added to the IntendedFor section before running for that subject.</p>
<p><strong>Deface T1 images</strong></p>
<p>Eventually, if you want to share de-identified data, you will need to deface the T1 images. You do not want to use the defaced images for any further preprocessing step. The script will run <a class="reference external" href="https://github.com/poldracklab/pydeface">pydeface</a> to deface T1w structural images and move the defaced image in your “extra” directory. It needs the subjectID and sessionID as input.</p>
<p>The script that does the can be found in <span class="blue">new_study_template/code/preprocessing/deface.sh</span>. We’re going to run it on the cluster so that it doesn’t freeze up your terminal window. So the outer script that will call it is <span class="blue">code/preprocessing/slurm_deface.sh</span>.</p>
<p>Before running the script:</p>
<ul class="simple">
<li><p>Make sure you updated your directories in globals.sh. If you will run deface.sh on your local computer, make sure the mounted directory is correct.</p></li>
<li><dl class="simple">
<dt>Make sure <a class="reference external" href="https://github.com/poldracklab/pydeface">pydeface</a> is installed on your local machine (or have it installed on the cluster you want to use, for Princeton e.g. spock).</dt><dd><ul>
<li><dl class="simple">
<dt>To install pydeface, do the following:</dt><dd><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">clone</span> <span class="pre">https://github.com/poldracklab/pydeface.git</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cd</span> <span class="pre">pydeface</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">setup.py</span> <span class="pre">install</span></code></p></li>
</ul>
</dd>
</dl>
</li>
<li><p>NOTE: Pydeface will only work if python 3 is the default on your machine (not python 2.7).</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
<p><em>Running deface on the cluster:</em></p>
<ul class="simple">
<li><dl class="simple">
<dt>Update lines in slurm_deface.sh:</dt><dd><ul>
<li><p>Line 7 → array number should be equal to all the subject numbers you want to run the script on (if you enter multiple, it will run them all in parallel) e.g., array=1,2,4</p></li>
<li><p>Lines 23 -24: update if you want to get an email with the update on the code</p></li>
<li><p>Line 39: change if you want to run on a different session besides session 1</p></li>
</ul>
</dd>
</dl>
</li>
<li><p><strong>To call the script, e.g. for the sample project:</strong> <code class="docutils literal notranslate"><span class="pre">sbatch</span> <span class="pre">slurm_deface.sh</span></code></p></li>
</ul>
<dl class="simple">
<dt><em>Running deface on your local computer:</em></dt><dd><ul class="simple">
<li><p>Mount serve volume via Finder and open a <em>local</em> Terminal window</p></li>
<li><dl class="simple">
<dt>From local Terminal, move to your bids directory:</dt><dd><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">cd</span> <span class="pre">/Volumes/norman/mydirectory/studies/</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cd</span> <span class="pre">mystudy/code/preprocessing.deface.sh</span></code></p></li>
</ul>
</dd>
</dl>
</li>
<li><p>Run  <span class="blue">deface.sh</span> with 2 inputs: subjectID and sessionID</p></li>
</ul>
</dd>
</dl>
<ul class="simple">
<li><p><strong>To call the script, e.g. for subject 999, session 01:</strong> <code class="docutils literal notranslate"><span class="pre">code/deface.sh</span> <span class="pre">999</span> <span class="pre">01</span></code></p></li>
</ul>
</div>
<div class="section" id="step-4-run-the-bids-validator">
<h3><em>Step 4: Run the BIDS validator</em><a class="headerlink" href="#step-4-run-the-bids-validator" title="Permalink to this headline">¶</a></h3>
<p>Once you have everything set up in the BIDS format, you can run the BIDS validator to make sure you have set it up correctly. You can check this using the following <a class="reference external" href="http://bids-standard.github.io/bids-validator/">bids validator</a> in a browser window. You can also setup a <span class="blue">.bidsignore</span> file if you have files or directories that are (deliberately) not valid BIDS format.</p>
<p><em>You can also install and run the validator locally:</em></p>
<ul class="simple">
<li><p>Install bids-validator on the server (e.g., spock). Go to your home directory and run the following:</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>npm install bids-validator
</pre></div>
</div>
<ul class="simple">
<li><p>This installation requires Node.js 10.11.0 or above to be installed beforehand.</p></li>
<li><p>Then you can check to make sure it’s there:</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>bids-validator -v
<span class="c1"># OR</span>
which bids-validator
</pre></div>
</div>
<ul class="simple">
<li><p><a class="reference external" href="httpps://github.com/bids-standard/bids-validator">More information about the bids validator installation can be found here</a></p></li>
<li><p>This installs bids-validator in <span class="blue">~/node_modules/.bin</span>. You can more easily call this by adding an alias to your <span class="blue">~/.bashrc configuration file</span>, e.g.:</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">alias</span> <span class="s1">&#39;bids-validator&#39;</span><span class="o">=</span><span class="s1">&#39;~/node_modules/.bin/bids-validator&#39;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Run run bids-validator:</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>bids-validator /BIDS_folder
</pre></div>
</div>
<ul class="simple">
<li><p>Read the “errors” and fix them and re-run until the Validator is appeased. Note that “warnings” can be ignored, but you’ll probably want to fix them at some point.</p></li>
</ul>
<a class="reference external image-reference" href="02-01-overview.html"><img alt="return to timeline" class="align-center" src="../_images/return_to_timeline.png" style="width: 300px;" /></a>
</div>
</div>
</div>


          </div>
              <div class="related bottom">
                &nbsp;
  <nav id="rellinks">
    <ul>
        <li>
          &larr;
          <a href="03-01-standard.html" title="Previous document">One standard to rule them all</a>
        </li>
        <li>
          <a href="03-03-mriqc.html" title="Next document">Quality control with MRIQC</a>
          &rarr;
        </li>
    </ul>
  </nav>
              </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
<div class="footer">
  <div style="text-align: left;" id="waldo-tag-2171"></div>
  <p>&copy;2019 CC-BY-SA - <a href="website_info.html">Website Info</a></p>
</div>


 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>

  </body>
</html>